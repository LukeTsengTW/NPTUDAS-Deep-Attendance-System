<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‡ºå¸­è¨˜éŒ„ - AIé»åç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 2em;
        }

        .header .actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            color: white;
        }

        .btn-primary {
            background: #667eea;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
        }

        .stat-card .number {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .stat-card .label {
            color: #666;
            font-size: 1.1em;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .date-section {
            margin-bottom: 30px;
        }

        .date-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .date-header:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .date-header h2 {
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .date-header .count {
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .records-table {
            width: 100%;
            border-collapse: collapse;
            overflow: hidden;
            border-radius: 10px;
        }

        .records-table thead {
            background: #667eea;
            color: white;
        }

        .records-table th {
            padding: 15px;
            text-align: left;
            font-weight: bold;
        }

        .records-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        .records-table tbody tr {
            transition: all 0.3s;
        }

        .records-table tbody tr:hover {
            background: #f8f9fa;
            transform: scale(1.01);
        }

        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .status-present {
            background: #d4edda;
            color: #155724;
        }

        .confidence-high {
            color: #28a745;
            font-weight: bold;
        }

        .confidence-medium {
            color: #ffc107;
            font-weight: bold;
        }

        .confidence-low {
            color: #dc3545;
            font-weight: bold;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state .icon {
            font-size: 5em;
            margin-bottom: 20px;
        }

        .empty-state p {
            font-size: 1.2em;
        }

        .filter-bar {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-bar input,
        .filter-bar select {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .filter-bar input:focus,
        .filter-bar select:focus {
            outline: none;
            border-color: #667eea;
        }

        .export-btn {
            margin-left: auto;
        }

        .records-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .records-content.active {
            max-height: 2000px;
        }

        .toggle-icon {
            transition: transform 0.3s ease;
        }

        .toggle-icon.rotated {
            transform: rotate(180deg);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸ“‹ å‡ºå¸­è¨˜éŒ„ç®¡ç†</h1>
            <div class="actions">
                <span style="color: #666; margin-right: 10px;">ğŸ‘¤ {{ username }}</span>
                <a href="/admin_dashboard" class="btn btn-primary">ğŸ”™ è¿”å›å¾Œå°</a>
                <a href="/" class="btn btn-secondary">ğŸ  è¿”å›ä¸»é </a>
            </div>
        </div>

        <!-- Statistics -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="label">ğŸ“… è¨˜éŒ„å¤©æ•¸</div>
                <div class="number">{{ total_dates }}</div>
            </div>
            <div class="stat-card">
                <div class="label">âœ… ç¸½å‡ºå¸­æ¬¡æ•¸</div>
                <div class="number">{{ records_by_date|sum(attribute='total_count') if records_by_date else 0 }}</div>
            </div>
            <div class="stat-card">
                <div class="label">ğŸ“Š ä»Šæ—¥å‡ºå¸­</div>
                <div class="number">{{ records_by_date[0].total_count if records_by_date else 0 }}</div>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="filter-bar">
            <span style="font-weight: bold; color: #667eea;">ğŸ” ç¯©é¸ï¼š</span>
            <input type="text" id="searchName" placeholder="æœå°‹å­¸ç”Ÿ..." onkeyup="filterRecords()">
            <input type="text" id="searchCourse" placeholder="æœå°‹èª²ç¨‹..." onkeyup="filterRecords()">
            <input type="text" id="searchInstructor" placeholder="æœå°‹æ•™å¸«..." onkeyup="filterRecords()">
            <input type="date" id="searchDate" onchange="filterRecords()">
            <button class="btn btn-success export-btn" onclick="exportToExcel()">
                ğŸ’¾ åŒ¯å‡º Excel
            </button>
        </div>

        <!-- Records by Date -->
        <div class="card">
            {% if records_by_date %}
                {% for date_data in records_by_date %}
                <div class="date-section">
                    <div class="date-header" onclick="toggleRecords('records-{{ loop.index }}')">
                        <h2>
                            ğŸ“… {{ date_data.date_display }}
                            <span style="font-size: 0.7em; color: rgba(255,255,255,0.8);">
                                ({{ ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'][date_data.date|date_to_weekday] }})
                            </span>
                        </h2>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <span class="count">å…± {{ date_data.total_count }} äººå‡ºå¸­</span>
                            <span class="toggle-icon" id="icon-{{ loop.index }}">â–¼</span>
                        </div>
                    </div>
                    
                    <div class="records-content active" id="records-{{ loop.index }}">
                        <table class="records-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>å§“å</th>
                                    <th>å­¸è™Ÿ</th>
                                    <th>èª²ç¨‹</th>
                                    <th>ç¯€æ¬¡</th>
                                    <th>ä»»èª²æ•™å¸«</th>
                                    <th>æ™‚é–“</th>
                                    <th>ä¿¡å¿ƒåº¦</th>
                                    <th>ç‹€æ…‹</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in date_data.records %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td><strong>{{ record.Name }}</strong></td>
                                    <td>{{ record.StudentID or 'N/A' }}</td>
                                    <td><span style="color: #667eea; font-weight: bold;">{{ record.Course or 'æœªè¨­å®š' }}</span></td>
                                    <td>{{ record.Session or '-' }}</td>
                                    <td>{{ record.Instructor or 'æœªè¨­å®š' }}</td>
                                    <td>{{ record.Time }}</td>
                                    <td>
                                        {% set conf_value = record.Confidence|replace('%', '')|float %}
                                        <span class="{% if conf_value >= 80 %}confidence-high{% elif conf_value >= 70 %}confidence-medium{% else %}confidence-low{% endif %}">
                                            {{ record.Confidence }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="status-badge status-present">
                                            âœ“ {{ record.Status }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <div class="icon">ğŸ“­</div>
                    <p>ç›®å‰é‚„æ²’æœ‰å‡ºå¸­è¨˜éŒ„</p>
                    <p style="font-size: 0.9em; margin-top: 10px; color: #bbb;">
                        ç•¶å­¸ç”Ÿå®Œæˆäººè‡‰è¾¨è­˜ç°½åˆ°å¾Œï¼Œè¨˜éŒ„æœƒé¡¯ç¤ºåœ¨é€™è£¡
                    </p>
                </div>
            {% endif %}
        </div>
    </div>

    <script>
        // åˆ‡æ›è¨˜éŒ„é¡¯ç¤º
        function toggleRecords(id) {
            const content = document.getElementById(id);
            const iconId = id.replace('records-', 'icon-');
            const icon = document.getElementById(iconId);
            
            content.classList.toggle('active');
            icon.classList.toggle('rotated');
        }

        // ç¯©é¸è¨˜éŒ„
        function filterRecords() {
            const searchName = document.getElementById('searchName').value.toLowerCase();
            const searchCourse = document.getElementById('searchCourse').value.toLowerCase();
            const searchInstructor = document.getElementById('searchInstructor').value.toLowerCase();
            const searchDate = document.getElementById('searchDate').value;
            
            const dateSections = document.querySelectorAll('.date-section');
            
            dateSections.forEach(section => {
                const dateHeader = section.querySelector('.date-header h2').textContent;
                const dateMatch = !searchDate || dateHeader.includes(searchDate);
                
                const rows = section.querySelectorAll('.records-table tbody tr');
                let visibleCount = 0;
                
                rows.forEach(row => {
                    const name = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                    const course = row.querySelector('td:nth-child(4)').textContent.toLowerCase();
                    const instructor = row.querySelector('td:nth-child(6)').textContent.toLowerCase();
                    const nameMatch = !searchName || name.includes(searchName);
                    const courseMatch = !searchCourse || course.includes(searchCourse);
                    const instructorMatch = !searchInstructor || instructor.includes(searchInstructor);
                    
                    if (nameMatch && courseMatch && instructorMatch && dateMatch) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                });
                
                // éš±è—æ•´å€‹æ—¥æœŸå€å¡Šï¼ˆè‹¥ç„¡å¯è¦‹è¨˜éŒ„ï¼‰
                if (dateMatch && visibleCount > 0) {
                    section.style.display = '';
                } else {
                    section.style.display = 'none';
                }
            });
        }

        // åŒ¯å‡ºåˆ° Excel
        function exportToExcel() {
            // å»ºç«‹ CSV å…§å®¹
            let csv = '\uFEFF'; // Excel ç”¨çš„ UTF-8 BOM
            csv += 'æ—¥æœŸ,å§“å,å­¸è™Ÿ,èª²ç¨‹,ç¯€æ¬¡,ä»»èª²æ•™å¸«,æ™‚é–“,ä¿¡å¿ƒåº¦,ç‹€æ…‹\n';
            
            const dateSections = document.querySelectorAll('.date-section');
            dateSections.forEach(section => {
                const date = section.querySelector('.date-header h2').textContent.split('(')[0].trim().replace('ğŸ“… ', '');
                const rows = section.querySelectorAll('.records-table tbody tr');
                
                rows.forEach(row => {
                    if (row.style.display !== 'none') {
                        const cells = row.querySelectorAll('td');
                        const name = cells[1].textContent;
                        const studentId = cells[2].textContent;
                        const course = cells[3].textContent;
                        const session = cells[4].textContent;
                        const instructor = cells[5].textContent;
                        const time = cells[6].textContent;
                        const confidence = cells[7].textContent.trim();
                        const status = cells[8].textContent.trim().replace('âœ“ ', '');
                        
                        csv += `${date},${name},${studentId},${course},${session},${instructor},${time},${confidence},${status}\n`;
                    }
                });
            });
            
            // å»ºç«‹ä¸‹è¼‰é€£çµ
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const now = new Date();
            const filename = `å‡ºå¸­è¨˜éŒ„_${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}.csv`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('å‡ºå¸­è¨˜éŒ„å·²åŒ¯å‡ºï¼');
        }

        // è‡ªå‹•å±•é–‹ä»Šå¤©çš„è¨˜éŒ„
        window.addEventListener('load', () => {
            const firstSection = document.querySelector('.records-content');
            if (firstSection) {
                firstSection.classList.add('active');
            }
        });
    </script>
</body>
</html>
