<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç”Ÿè¨»å†Š - AIé»åç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            width: 100%;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .registration-panel {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        .capture-section {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .video-container {
            position: relative;
        }

        #video {
            width: 100%;
            border-radius: 10px;
            background: #000;
            display: none;
        }

        #canvas {
            display: none;
        }

        .quality-indicator {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 10;
        }

        .quality-bar {
            width: 100%;
            height: 8px;
            background: #ddd;
            border-radius: 4px;
            margin-top: 5px;
            overflow: hidden;
        }

        .quality-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff4444, #ffaa00, #44ff44);
            width: 0%;
            transition: width 0.3s;
        }

        .preview-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .preview-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease;
        }

        .preview-item img {
            width: 60px;
            height: 60px;
            border-radius: 5px;
            object-fit: cover;
        }

        .preview-info {
            flex: 1;
        }

        .preview-status {
            font-size: 12px;
            color: #28a745;
            font-weight: bold;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .progress-info {
            text-align: center;
            font-size: 18px;
            color: #667eea;
            margin: 20px 0;
            font-weight: bold;
        }

        .message {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .capture-modes {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .mode-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .mode-btn.active {
            background: #667eea;
            color: white;
        }

        .mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @media (max-width: 768px) {
            .capture-section {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.8em;
            }
        }
    </style>
<script type="text/javascript" nonce="bcbd16e207544e6584f6465859b" src="//local.adguard.org?ts=1759829422653&amp;type=content-script&amp;dmn=ppl-ai-code-interpreter-files.s3.amazonaws.com&amp;url=https%3A%2F%2Fppl-ai-code-interpreter-files.s3.amazonaws.com%2Fweb%2Fdirect-files%2F63f7d9eed701c6774ce961e280b97646%2Ff942ab5c-3b59-4c21-a389-26a28ce0a83d%2Fb501885e.html%3Fresponse-content-disposition%3Dattachment%253B%2520filename%253Dregister.html%253B%2520filename%252A%253DUTF-8%2527%2527register.html%26AWSAccessKeyId%3DASIA2F3EMEYEZDSNIGLD%26Signature%3DhnI4VTyQUdaN4q5Cj9CSmgUMO0E%253D%26x-amz-security-token%3DIQoJb3JpZ2luX2VjEAoaCXVzLWVhc3QtMSJHMEUCIQCZNmm%252FUNSNSNCeF4CFOumpq%252FHbhi%252FYqVMoDo%252BABhRJTwIgeS00UTrV5tjQD0YkzsfSFK%252FkjgpJ4ixN1%252BnLK0Au8zIq%252BgQIov%252F%252F%252F%252F%252F%252F%252F%252F%252F%252FARABGgw2OTk3NTMzMDk3MDUiDB9nNfBJTjoOTeNFGSrOBC0K6rRsMgg0MIV8ImXM%252FEU3LqHGFhxpZJJNB4%252FvDfU4IcejAnW7rStGCX4IPHq0q3b5DMFgnm8sqoauq%252FSSnxDELgbIlMB2f8%252BmEBvOivGe8m1CMFcTm%252FBNhKADIH0dxTkk91dwULwRQ4Wpa73%252Fh1EIFO3SM3fjTsoqsWixPrruXuWORfBVPJAQdeNzP8OxMZEoVQw5%252BtRfLP1Zz5YmQHa3CRSiSE%252FaQHUMpGbhK88qquYhlw18rk5J7OyTZLiGPZDDUXZ0ES4U5YQ9bK7IMNP%252BffejHPZ7eOMeGLDVAA3HCJXxhoBO65O1QaW9lOy0LRLiYpjvqeYwnuDxPSGQkvh3tODdp5KSIThCKfoO6DpZRQBuYKEqhZNVVoVhmrmULirN%252F%252F9kzLfWzDjQwq0IjM1Ul5OiTi2DfFyXG6cAa8DyOgQdWb6mrwu3eH1UiVWF6kD8zxgS6MqN08orUcJisrYeSJuK%252FNG%252BYlP8VzeM5sGUkha%252FEE9rOwCkuglLXc2zziyu%252BgQHQQzWuqvmwmflWP%252BXaskUXKy3xZSGoigxW%252Fwr%252FfJntAx9QXe1TSC3kn1jSmH08CYe2XQmjZvUb0%252BZnx%252BcfeMpWLJk0FEqaiQX3AiSMJJdgQHg9HYRl%252F9vusL1lZDqdlcZDB%252FeIZi5QswWiADXz49rZe%252Bh8bSk1%252Bh2VuTxZh3LBWqUbQOmqiuI2i6jU9HaGZ%252Fq0iWuBQf1s5fA2SS8hOXs8hjSUqC5lrGxFQ8aCga%252FVAxNS3XMPhGPOrlSCHGuRBSISsAx5BVjEqD6MPi0k8cGOpoBcSW8gsoSK%252B2SnPr5w8zEGGs%252FijNcJ24zhHz6fm9pKqHrxmbwVY1in7LnVmQdEWqYiyElpi8JhRy5Mhpv4AIXTk8Eq96%252FLPJ%252FEhYPr83nL%252B9qD8zdS0Xkjjwaa8aZlp3aTXA9Q2c7u2lpfCqrru7DhUjAAREWE1Ifp%252Bt5byJ1FlouEZbHKRBsi%252FT%252Fq4%252BLtFutb0EqZkwkSeZ6sw%253D%253D%26Expires%3D1759831050&amp;app=chrome.exe&amp;css=3&amp;js=1&amp;rel=1&amp;rji=1&amp;sbe=1"></script><script type="text/javascript" nonce="bcbd16e207544e6584f6465859b" src="//local.adguard.org?ts=1759829422653&amp;name=AdGuard%20Extra&amp;name=AdGuard%20Popup%20Blocker&amp;type=user-script"></script></head>
<body>
    <div class="container">
        <h1>ğŸ“ å­¸ç”Ÿè¨»å†Šç³»çµ±</h1>

        <div class="registration-panel">
            <div class="form-group">
                <label for="studentName">å­¸ç”Ÿå§“å *</label>
                <input type="text" id="studentName" placeholder="è«‹è¼¸å…¥å­¸ç”Ÿå§“å" required>
            </div>

            <div class="form-group">
                <label for="studentId">å­¸è™Ÿ *</label>
                <input type="text" id="studentId" placeholder="è«‹è¼¸å…¥å­¸è™Ÿï¼ˆå¦‚ï¼šCBE114001ï¼‰" required>
                <small style="color: #666;">å­¸è™Ÿå°‡é¡¯ç¤ºåœ¨è­˜åˆ¥æ¡†ä¸­</small>
            </div>

            <div class="form-group">
                <label for="photoCount">æ‹æ”å¼µæ•¸ï¼ˆå»ºè­°5-10å¼µï¼‰*</label>
                <input type="number" id="photoCount" value="5" min="3" max="20">
                <small style="color: #666;">å¼µæ•¸è¶Šå¤šï¼Œè¾¨è­˜æº–ç¢ºåº¦è¶Šé«˜</small>
            </div>

            <div class="form-group">
                <button class="btn btn-primary" id="btnStartCapture">é–‹å§‹æ‹æ”</button>
                <button class="btn btn-secondary" onclick="goBackToHome()">è¿”å›ä¸»é </button>
            </div>

            <div id="message" class="message"></div>
        </div>

        <div class="registration-panel" id="capturePanel" style="display: none;">
            <div class="progress-info" id="progressInfo">æº–å‚™ä¸­...</div>

            <div class="capture-modes">
                <button class="mode-btn active" data-mode="auto">
                    ğŸ¤– è‡ªå‹•æ‹æ”æ¨¡å¼<br>
                    <small>ç³»çµ±åµæ¸¬åˆ°äººè‡‰å“è³ªè‰¯å¥½æ™‚è‡ªå‹•æ‹æ”</small>
                </button>
                <button class="mode-btn" data-mode="manual">
                    ğŸ‘† æ‰‹å‹•æ‹æ”æ¨¡å¼<br>
                    <small>æŒ‰ä¸‹æŒ‰éˆ•æ‰‹å‹•æ‹æ”</small>
                </button>
            </div>

            <div class="capture-section">
                <div class="video-container">
                    <video id="video" autoplay playsinline></video>
                    <canvas id="canvas"></canvas>
                    <div class="quality-indicator" id="qualityIndicator">
                        <div>äººè‡‰å“è³ª: <span id="qualityScore">0</span>%</div>
                        <div class="quality-bar">
                            <div class="quality-fill" id="qualityFill"></div>
                        </div>
                        <div id="qualityMessage" style="margin-top: 5px; font-size: 12px;">ç­‰å¾…åµæ¸¬...</div>
                    </div>
                </div>

                <div class="preview-container">
                    <h3 style="margin-bottom: 10px;">ğŸ“¸ å·²æ‹æ”ç…§ç‰‡</h3>
                    <div id="previewList" style="max-height: 400px; overflow-y: auto;"></div>
                    <button class="btn btn-success" id="btnManualCapture" style="margin-top: 10px; display: none;">
                        ğŸ“· æ‰‹å‹•æ‹æ”
                    </button>
                    <button class="btn btn-primary" id="btnFinish" style="display: none;">
                        âœ… å®Œæˆè¨»å†Š
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let video, canvas, ctx;
        let studentName, photoCount, capturedCount = 0;
        let captureMode = 'auto';
        let isChecking = false;
        let autoCaptureCooldown = false;
        let videoStream = null;  // è¿½è¹¤å½±åƒæµ

        document.getElementById('btnStartCapture').addEventListener('click', startCapture);
        document.getElementById('btnFinish').addEventListener('click', finishRegistration);
        document.getElementById('btnManualCapture').addEventListener('click', manualCapture);

        // åœæ­¢é¡é ­å‡½æ•¸
        function stopCamera() {
            console.log('åœæ­¢é¡é ­...');
            if (videoStream) {
                videoStream.getTracks().forEach(track => {
                    track.stop();
                    console.log('å·²åœæ­¢è»Œé“:', track.kind);
                });
                videoStream = null;
            }
            if (video && video.srcObject) {
                video.srcObject = null;
            }
        }

        // é é¢å¸è¼‰æ™‚åœæ­¢é¡é ­
        window.addEventListener('beforeunload', function(e) {
            stopCamera();
        });

        // ç›£è½é é¢å¯è¦‹æ€§è®ŠåŒ–
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopCamera();
            }
        });

        // è¿”å›ä¸»é å‰åœæ­¢é¡é ­
        function goBackToHome() {
            stopCamera();
            setTimeout(() => {
                location.href = '/';
            }, 500);  // å»¶é² 0.5 ç§’ç¢ºä¿é¡é ­é‡‹æ”¾
        }

        // åˆ‡æ›æ‹æ”æ¨¡å¼
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                captureMode = this.dataset.mode;

                const manualBtn = document.getElementById('btnManualCapture');
                if (captureMode === 'manual') {
                    manualBtn.style.display = 'block';
                } else {
                    manualBtn.style.display = 'none';
                }
            });
        });

        async function startCapture() {
            studentName = document.getElementById('studentName').value.trim();
            const studentId = document.getElementById('studentId').value.trim();
            photoCount = parseInt(document.getElementById('photoCount').value);

            if (!studentName) {
                showMessage('è«‹è¼¸å…¥å­¸ç”Ÿå§“å', 'error');
                return;
            }

            if (!studentId) {
                showMessage('è«‹è¼¸å…¥å­¸è™Ÿ', 'error');
                return;
            }

            if (photoCount < 3 || photoCount > 20) {
                showMessage('æ‹æ”å¼µæ•¸å¿…é ˆåœ¨3-20ä¹‹é–“', 'error');
                return;
            }

            // é€šçŸ¥å¾Œç«¯é–‹å§‹è¨»å†Š
            const response = await fetch('/start_registration', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name: studentName, student_id: studentId, photo_count: photoCount})
            });

            const result = await response.json();
            if (!result.success) {
                showMessage(result.message, 'error');
                return;
            }

            // é¡¯ç¤ºæ‹æ”é¢æ¿
            document.getElementById('capturePanel').style.display = 'block';
            capturedCount = 0;
            updateProgress();

            // å•Ÿå‹•é¡é ­
            showMessage('æ­£åœ¨æº–å‚™é¡é ­...', 'info');
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });

                videoStream = stream;  // ä¿å­˜æµå¼•ç”¨
                video = document.getElementById('video');
                canvas = document.getElementById('canvas');
                ctx = canvas.getContext('2d');

                video.srcObject = stream;
                video.style.display = 'block';

                // ç­‰å¾…è¦–è¨Šè¼‰å…¥
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;

                    // é–‹å§‹å“è³ªæª¢æ¸¬å¾ªç’°
                    if (captureMode === 'auto') {
                        checkFaceQuality();
                    }
                };

                showMessage('é¡é ­æº–å‚™å®Œæˆï¼', 'success');

            } catch (error) {
                showMessage('ç„¡æ³•å­˜å–é¡é ­: ' + error.message + ' (è«‹ç¢ºä¿ä¸»é å½±åƒæµå·²é—œé–‰)', 'error');
                console.error('Camera error:', error);
            }
        }

        async function checkFaceQuality() {
            if (!video || capturedCount >= photoCount) return;

            if (!isChecking) {
                isChecking = true;

                // æ•æ‰ç•¶å‰å½±æ ¼
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = canvas.toDataURL('image/jpeg', 0.9);

                try {
                    const response = await fetch('/check_face_quality', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({image: imageData})
                    });

                    const result = await response.json();

                    // æ›´æ–°å“è³ªæŒ‡ç¤ºå™¨
                    document.getElementById('qualityScore').textContent = result.quality || 0;
                    document.getElementById('qualityFill').style.width = (result.quality || 0) + '%';
                    document.getElementById('qualityMessage').textContent = result.message || 'æª¢æ¸¬ä¸­...';

                    // è‡ªå‹•æ‹æ”ï¼ˆå“è³ªè‰¯å¥½ä¸”æ²’æœ‰å†·å»ä¸­ï¼‰
                    if (result.can_capture && !autoCaptureCooldown && captureMode === 'auto') {
                        await capturePhoto(imageData);

                        // è¨­å®šå†·å»æ™‚é–“ï¼ˆ2ç§’ï¼‰ï¼Œé¿å…é€£çºŒæ‹æ”ç›¸ä¼¼ç…§ç‰‡
                        autoCaptureCooldown = true;
                        setTimeout(() => {
                            autoCaptureCooldown = false;
                        }, 2000);
                    }

                } catch (error) {
                    console.error('å“è³ªæª¢æ¸¬å¤±æ•—:', error);
                }

                isChecking = false;
            }

            // æŒçºŒæª¢æ¸¬
            if (captureMode === 'auto' && capturedCount < photoCount) {
                setTimeout(checkFaceQuality, 200);  // æ¯200æ¯«ç§’æª¢æ¸¬ä¸€æ¬¡
            }
        }

        async function manualCapture() {
            if (capturedCount >= photoCount) return;

            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = canvas.toDataURL('image/jpeg', 0.9);
            await capturePhoto(imageData);
        }

        async function capturePhoto(imageData) {
            showMessage(`æ­£åœ¨æ‹æ”ç¬¬ ${capturedCount + 1} å¼µç…§ç‰‡...`, 'info');

            try {
                const response = await fetch('/capture_photo', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        name: studentName,
                        index: capturedCount + 1,
                        image: imageData
                    })
                });

                const result = await response.json();

                if (result.success) {
                    capturedCount++;
                    addPreview(imageData, capturedCount);
                    updateProgress();
                    showMessage(result.message, 'success');

                    // å®Œæˆæ‰€æœ‰æ‹æ”
                    if (capturedCount >= photoCount) {
                        showMessage(`å·²å®Œæˆæ‰€æœ‰ ${photoCount} å¼µç…§ç‰‡æ‹æ”ï¼`, 'success');
                        document.getElementById('btnFinish').style.display = 'block';

                        // åœæ­¢é¡é ­
                        stopCamera();
                    }
                } else {
                    showMessage(result.message, 'error');
                }

            } catch (error) {
                showMessage('æ‹æ”å¤±æ•—: ' + error.message, 'error');
            }
        }

        function addPreview(imageData, index) {
            const previewList = document.getElementById('previewList');
            const previewItem = document.createElement('div');
            previewItem.className = 'preview-item';
            previewItem.innerHTML = `
                <img src="${imageData}" alt="Photo ${index}">
                <div class="preview-info">
                    <div>ç…§ç‰‡ ${index}</div>
                    <div class="preview-status">âœ“ å·²å„²å­˜</div>
                </div>
            `;
            previewList.appendChild(previewItem);

            // è‡ªå‹•æ»¾å‹•åˆ°æœ€æ–°ç…§ç‰‡
            previewList.scrollTop = previewList.scrollHeight;
        }

        function updateProgress() {
            const progress = document.getElementById('progressInfo');
            progress.textContent = `æ‹æ”é€²åº¦: ${capturedCount} / ${photoCount}`;
        }

        async function finishRegistration() {
            // å…ˆåœæ­¢é¡é ­
            stopCamera();
            
            showMessage('æ­£åœ¨è¨“ç·´æ¨¡å‹ï¼Œè«‹ç¨å€™...', 'info');
            document.getElementById('btnFinish').disabled = true;

            try {
                const response = await fetch('/finish_registration', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name: studentName})
                });

                const result = await response.json();

                if (result.success) {
                    showMessage(result.message + ' å³å°‡è¿”å›ä¸»é ...', 'success');
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    location.href = '/';
                } else {
                    showMessage(result.message, 'error');
                    document.getElementById('btnFinish').disabled = false;
                }

            } catch (error) {
                showMessage('è¨»å†Šå¤±æ•—: ' + error.message, 'error');
                document.getElementById('btnFinish').disabled = false;
            }
        }

        function showMessage(text, type) {
            const message = document.getElementById('message');
            message.textContent = text;
            message.className = 'message ' + type;
            message.style.display = 'block';

            if (type !== 'info') {
                setTimeout(() => {
                    message.style.display = 'none';
                }, 5000);
            }
        }
    </script>
</body>
</html>